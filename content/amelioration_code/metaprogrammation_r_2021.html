---
title: "Métaprogrammation en R"
author: "Sophie Baillargeon, Université Laval"
date: "2021-04-04"
weight: 3
slug: "metaprogrammation_r"
lastmodifierdisplayname: "Sophie Baillargeon"
lastmodifieremail: "sophie.baillargeon@mat.ulaval.ca"
output:
  pdf_document:
    toc: yes
    toc_depth: 3
    number_sections: yes
    highlight: tango
  blogdown::html_page:
    toc: yes
    toc_depth: 3
    number_sections: yes
    highlight: tango
header-includes:
- \usepackage[french]{babel}
- \frenchbsetup{StandardLayout}
- \hypersetup{colorlinks=true, urlcolor = {blue}, linkcolor = {blue}}
editor_options: 
  chunk_output_type: console
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<div id="TOC">
<ul>
<li><a href="#assignation-dune-valeur-à-un-nom-avec-assign"><span class="toc-section-number">1</span> Assignation d’une valeur à un nom avec <code>assign</code></a></li>
<li><a href="#retour-de-la-valeur-assignée-à-un-nom-avec-get"><span class="toc-section-number">2</span> Retour de la valeur assignée à un nom avec <code>get</code></a></li>
<li><a href="#appel-dune-fonction-avec-do.call"><span class="toc-section-number">3</span> Appel d’une fonction avec <code>do.call</code></a></li>
<li><a href="#manipulation-de-formules"><span class="toc-section-number">4</span> Manipulation de formules</a>
<ul>
<li><a href="#fonction-as.formula"><span class="toc-section-number">4.1</span> Fonction <code>as.formula</code></a></li>
<li><a href="#méthode-update.formula"><span class="toc-section-number">4.2</span> Méthode <code>update.formula</code></a></li>
</ul></li>
<li><a href="#manipulation-dinstructions"><span class="toc-section-number">5</span> Manipulation d’instructions</a>
<ul>
<li><a href="#fonctions-quote-et-expression"><span class="toc-section-number">5.1</span> Fonctions <code>quote</code> et <code>expression</code></a></li>
<li><a href="#fonction-eval"><span class="toc-section-number">5.2</span> Fonction <code>eval</code></a></li>
<li><a href="#fonction-call"><span class="toc-section-number">5.3</span> Fonction <code>call</code></a></li>
<li><a href="#fonction-parse"><span class="toc-section-number">5.4</span> Fonction <code>parse</code></a></li>
</ul></li>
<li><a href="#manipulation-de-lappel-dune-fonction"><span class="toc-section-number">6</span> Manipulation de l’appel d’une fonction</a>
<ul>
<li><a href="#fonctions-substitute-et-deparse"><span class="toc-section-number">6.1</span> Fonctions <code>substitute</code> et <code>deparse</code></a></li>
<li><a href="#fonction-match.call"><span class="toc-section-number">6.2</span> Fonction <code>match.call</code></a></li>
</ul></li>
<li><a href="#résumé"><span class="toc-section-number">7</span> Résumé</a></li>
<li><a href="#références">Références</a></li>
</ul>
</div>

<hr />
<p><em>Note préliminaire : Lors de leur dernière mise à jour, ces notes ont été révisées en utilisant R version 4.0.3.</em></p>
<hr />
<p>La métaprogrammation se définit par l’écriture d’un programme qui écrit lui-même un programme. En d’autres mots, faire de la métaprogrammation signifie de manipuler des éléments de langage sans les évaluer. En R, des exemples d’éléments du langage sont les noms, les formules, les expressions, les appels de fonctions, etc. Il est donc possible en R d’écrire un bout de code qui compose d’abord une ou des instructions sous forme d’expressions ou de chaînes de caractères, puis qui évalue ces instructions dans un deuxième temps. La métaprogrammation est parfois utile pour automatiser des calculs. Elle sert aussi à réaliser certaines tâches spécifiques, par exemple l’ajout d’annotations mathématiques à un graphique (abordé dans les <a href="https://stt4230.rbind.io/communication_resultats/graphiques_r/#annotations-math%C3%A9matiques">notes sur les graphiques en R</a>)</p>
<p>Les sections qui suivent décrivent quelques outils de métaprogrammation en R.</p>
<div id="assignation-dune-valeur-à-un-nom-avec-assign" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Assignation d’une valeur à un nom avec <code>assign</code></h1>
<p>Voici un exemple d’instruction R qui utilise la façon usuelle d’écrire une assignation en R :</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">head</span>(letters)</span></code></pre></div>
<p>Dans cette instruction, qui utilise l’opérateur d’assignation <code>&lt;-</code>,</p>
<ul>
<li><code>obj</code> est le nom référant à l’objet créé en mémoire;</li>
<li><code>head(letters)</code> est l’expression dont la valeur, obtenue après évaluation, est enregistrée dans l’objet créé en mémoire.</li>
</ul>
<p>Un nom est en fait un symbole relié à un objet.</p>
<p>Mais comment assigner une valeur à un nom stocké dans un objet sous forme de chaîne de caractères ? Par exemple, supposons que ce nom est stocké dans l’objet <code>nom</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>nom <span class="ot">&lt;-</span> <span class="st">&quot;nom_objet&quot;</span></span></code></pre></div>
<p>Nous voulons assigner une valeur au nom stocké dans <code>nom</code>, peu importe la chaîne de caractères que <code>nom</code> contient. Cette assignation peut être réalisée avec la fonction <code>assign</code> comme dans cet exemple :</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">assign</span>(<span class="at">x =</span> nom, <span class="at">value =</span> <span class="fu">head</span>(letters))</span></code></pre></div>
<p>Que contient notre environnement de travail maintenant?</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span>()</span></code></pre></div>
<pre><code>## [1] &quot;nom&quot;       &quot;nom_objet&quot; &quot;obj&quot;</code></pre>
<p>Nous y trouvons un objet nommé <code>nom_objet</code>, ce qui correspond à la chaîne de caractères stockée dans <code>nom</code>. Cet objet contient la valeur (a, b, c, d, e, f), soit le vecteur des six premières lettres de l’alphabet latin créé par l’expression <code>head(letters)</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>nom_objet</span></code></pre></div>
<pre><code>## [1] &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot; &quot;e&quot; &quot;f&quot;</code></pre>
<p>Voici un autre exemple d’utilisation de la fonction <code>assign</code>. Supposons que nous souhaitons créer 5 objets, nommés <code>obj1</code> à <code>obj5</code>. Ces objets doivent contenir un vecteur d’entiers allant de 1 à <code>x</code> où <code>x</code> est le numéro de l’objet.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="dv">5</span>)) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assign</span>(<span class="at">x =</span> <span class="fu">paste0</span>(<span class="st">&quot;obj&quot;</span>, i), <span class="at">value =</span> <span class="dv">1</span><span class="sc">:</span>i)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Vérifions que ces objets ont bien été créés dans notre environnement de travail.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span>()</span></code></pre></div>
<pre><code>## [1] &quot;i&quot;         &quot;nom&quot;       &quot;nom_objet&quot; &quot;obj&quot;       &quot;obj1&quot;      &quot;obj2&quot;     
## [7] &quot;obj3&quot;      &quot;obj4&quot;      &quot;obj5&quot;</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>obj1</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>obj5</span></code></pre></div>
<pre><code>## [1] 1 2 3 4 5</code></pre>
</div>
<div id="retour-de-la-valeur-assignée-à-un-nom-avec-get" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Retour de la valeur assignée à un nom avec <code>get</code></h1>
<p>Pour atteindre la valeur assignée à un nom, nous sommes habitués à passer directement par ce nom, comme dans cet exemple.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(nom_objet)</span></code></pre></div>
<pre><code>##  chr [1:6] &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot; &quot;e&quot; &quot;f&quot;</code></pre>
<p>Mais comment procéder avec un nom stocké dans un objet sous forme de chaîne de caractères ? Il faut utiliser la fonction <code>get</code> comme suit.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(<span class="fu">get</span>(nom))</span></code></pre></div>
<pre><code>##  chr [1:6] &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot; &quot;e&quot; &quot;f&quot;</code></pre>
<p>Ce qui ne retourne pas la même chose que ceci.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(nom)</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Équivalent à</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(<span class="st">&quot;nom_objet&quot;</span>)</span></code></pre></div>
<pre><code>##  chr &quot;nom_objet&quot;</code></pre>
<p>Par exemple, pour afficher le contenu des objets nommés <code>obj1</code> à <code>obj5</code>, nous pouvons procéder comme suit.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">&quot;obj&quot;</span>, i), <span class="st">&quot;=&quot;</span>, <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">&quot;obj&quot;</span>, i)), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## obj1 = 1 
## obj2 = 1 2 
## obj3 = 1 2 3 
## obj4 = 1 2 3 4 
## obj5 = 1 2 3 4 5</code></pre>
</div>
<div id="appel-dune-fonction-avec-do.call" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Appel d’une fonction avec <code>do.call</code></h1>
<p>Nous venons d’apprendre comment manipuler un nom que nous possédons sous forme de chaîne de caractères. Comment procéder lorsque ce nom est celui d’une fonction que nous souhaitons appeler?</p>
<p>Il est alors possible d’utiliser <code>get</code>, mais une autre fonction peut aussi nous être utile : <code>do.call</code>.</p>
<p>Par exemple, les trois instructions suivantes provoquent toute l’évaluation du même appel à la fonction <code>median</code>.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>## [1] 5.5</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get</span>(<span class="st">&quot;median&quot;</span>)(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>## [1] 5.5</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">do.call</span>(<span class="st">&quot;median&quot;</span>, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>))</span></code></pre></div>
<pre><code>## [1] 5.5</code></pre>
<p>En fait, l’avantage de <code>do.call</code> n’est pas qu’il soit capable de manipuler une fonction dont le nom est sous forme de chaîne de caractères. D’ailleurs, <code>do.call</code> accepte comme premier argument la fonction directement. Sa principale utilité est plutôt d’accepter sous forme de liste les arguments à inclure dans l’appel à une fonction. Cette liste peut être construite par étapes, potentiellement conditionnelles.</p>
<p>Voici un exemple de fonction qui exploite le potentiel de la fonction <code>do.call</code>.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @title Calcul de statistiques descriptives</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @description Cette fonction permet de calculer des statistiques descriptives au choix</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x vecteur d&#39;observations</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param choix une chaîne de caractères spécifiant le nom de la fonction à appeler pour</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;              le calcul, soit &quot;table&quot; (par défaut), &quot;mean&quot;, &quot;median&quot;, &quot;sd&quot; ou &quot;mad&quot;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param retirer_NA un logique spécifiant si les valeurs manquantes (NA)</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39;                   doivent être retirées avant le calcul (par défaut TRUE)</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return le résultat de l&#39;appel à la fonction choisie</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>choixstat <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">choix =</span> <span class="fu">c</span>(<span class="st">&quot;table&quot;</span>, <span class="st">&quot;mean&quot;</span>, <span class="st">&quot;median&quot;</span>, <span class="st">&quot;sd&quot;</span>, <span class="st">&quot;mad&quot;</span>),</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">retirer_NA =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  choix <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(choix)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  arguments <span class="ot">&lt;-</span> <span class="fu">list</span>(x)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (choix <span class="sc">==</span> <span class="st">&quot;table&quot;</span>) {</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    arguments<span class="sc">$</span>useNA <span class="ot">&lt;-</span> <span class="cf">if</span> (retirer_NA) <span class="st">&quot;no&quot;</span> <span class="cf">else</span> <span class="st">&quot;ifany&quot;</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    arguments<span class="sc">$</span>na.rm <span class="ot">&lt;-</span> retirer_NA</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">do.call</span>(<span class="at">what =</span> choix, <span class="at">args =</span> arguments))</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">choixstat</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="cn">NA</span>, <span class="dv">3</span>), <span class="at">choix =</span> <span class="st">&quot;median&quot;</span>, <span class="at">retirer_NA =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Équivalent</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="cn">NA</span>, <span class="dv">3</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## [1] 3</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">choixstat</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="cn">NA</span>, <span class="dv">3</span>), <span class="at">choix =</span> <span class="st">&quot;median&quot;</span>, <span class="at">retirer_NA =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Équivalent à </span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="cn">NA</span>, <span class="dv">3</span>), <span class="at">na.rm =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## [1] NA</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">choixstat</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="cn">NA</span>, <span class="dv">3</span>), <span class="at">choix =</span> <span class="st">&quot;table&quot;</span>, <span class="at">retirer_NA =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Équivalent à </span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="cn">NA</span>, <span class="dv">3</span>), <span class="at">useNA =</span> <span class="st">&quot;no&quot;</span>)</span></code></pre></div>
<pre><code>## 
## 2 3 4 
## 2 4 1</code></pre>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">choixstat</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="cn">NA</span>, <span class="dv">3</span>), <span class="at">choix =</span> <span class="st">&quot;table&quot;</span>, <span class="at">retirer_NA =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Équivalent à </span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="cn">NA</span>, <span class="dv">3</span>), <span class="at">useNA =</span> <span class="st">&quot;ifany&quot;</span>)</span></code></pre></div>
<pre><code>## 
##    2    3    4 &lt;NA&gt; 
##    2    4    1    1</code></pre>
</div>
<div id="manipulation-de-formules" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Manipulation de formules</h1>
<p>Les formules sont des éléments de langage R particuliers. Ils servent à spécifier des modèles statistiques. L’instruction suivante est un exemple de création d’une formule en R.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>f1 <span class="ot">&lt;-</span> y <span class="sc">~</span> x1 <span class="sc">+</span> x2</span></code></pre></div>
<p>Une formule contient un opérateur <code>~</code>, possiblement avec un argument à gauche pour spécifier la ou les variables réponses du modèle et un argument à droite pour spécifier la ou les variables explicatives du modèle. Des informations sur les formules ont été fournies dans le cours sur les <a href="https://stt4230.rbind.io/calculs/calculs_stat_r/#formules">calculs statistiques en R</a>.</p>
<p>R reconnaît que <code>f1</code> est bien une formule. Il la décompose même en trois parties : l’opérateur <code>~</code>, la partie de gauche du modèle (en anglais <em>LHS</em> pour <em>left hand side</em>) et la partie de droite du modèle (en anglais <em>RHS</em> pour <em>right hand side</em>).</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(f1)</span></code></pre></div>
<pre><code>## Class &#39;formula&#39;  language y ~ x1 + x2
##   ..- attr(*, &quot;.Environment&quot;)=&lt;environment: R_GlobalEnv&gt;</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>f1[<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## `~`()</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>f1[<span class="dv">2</span>]</span></code></pre></div>
<pre><code>## y()</code></pre>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>f1[<span class="dv">3</span>]</span></code></pre></div>
<pre><code>## (x1 + x2)()</code></pre>
<div id="fonction-as.formula" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Fonction <code>as.formula</code></h2>
<p>La fonction <code>as.formula</code> permet de créer une formule à partir d’une chaîne de caractères.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(<span class="st">&quot;y ~ x1 + x2&quot;</span>)</span></code></pre></div>
<pre><code>##  chr &quot;y ~ x1 + x2&quot;</code></pre>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>f2 <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="st">&quot;y ~ x1 + x2&quot;</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(f2)</span></code></pre></div>
<pre><code>## Class &#39;formula&#39;  language y ~ x1 + x2
##   ..- attr(*, &quot;.Environment&quot;)=&lt;environment: R_GlobalEnv&gt;</code></pre>
<p>Cette possibilité de transformer une chaîne de caractères en formule s’avère pratique, par exemple, lorsque nous avons besoin de construire une formule comprenant un grand nombre de termes identifiables de façon automatique.</p>
<p>Voici un exemple de fonction qui utilise <code>as.formula</code> pour construire un modèle de régression polynomial.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @tital Régression polynomiale</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @description Ajustement d&#39;un modèle de régression polynomial entre deux variables</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param y vecteur des observations de la variable réponse</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param x vecteur des observations de la variable explicative</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @param dg degré du modèle polynomial à ajuster</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @return sortie de la fonction lm pour le modèle demandé</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>reg_poly <span class="ot">&lt;-</span> <span class="cf">function</span>(y, x, dg){</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  formule <span class="ot">&lt;-</span> <span class="fu">paste</span>(</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;y ~&quot;</span>, </span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="fu">paste0</span>(<span class="st">&quot;I(x^&quot;</span>, <span class="dv">1</span><span class="sc">:</span>dg, <span class="st">&quot;)&quot;</span>), <span class="at">collapse =</span> <span class="st">&quot; + &quot;</span>)</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">lm</span>(<span class="fu">as.formula</span>(formule)))</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reg_poly</span>(<span class="at">y =</span> cars<span class="sc">$</span>dist, <span class="at">x =</span> cars<span class="sc">$</span>speed, <span class="at">dg =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = as.formula(formule))
## 
## Coefficients:
## (Intercept)       I(x^1)       I(x^2)       I(x^3)  
##   -19.50505      6.80111     -0.34966      0.01025</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reg_poly</span>(<span class="at">y =</span> cars<span class="sc">$</span>dist, <span class="at">x =</span> cars<span class="sc">$</span>speed, <span class="at">dg =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = as.formula(formule))
## 
## Coefficients:
## (Intercept)       I(x^1)       I(x^2)       I(x^3)       I(x^4)       I(x^5)  
##   -2.650053     5.484259    -1.426123     0.194049    -0.010040     0.000179</code></pre>
</div>
<div id="méthode-update.formula" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> Méthode <code>update.formula</code></h2>
<p>La méthode <code>update.formula</code> permet de partir d’un modèle et de le modifier. Par exemple, reprenons la formule <code>f1</code>.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>f1</span></code></pre></div>
<pre><code>## y ~ x1 + x2</code></pre>
<p>Ajoutons-y une variable explicative.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">update</span>(f1, . <span class="sc">~</span> . <span class="sc">+</span> x3)</span></code></pre></div>
<pre><code>## y ~ x1 + x2 + x3</code></pre>
<p>Ou encore, retirons une variable.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">update</span>(f1, . <span class="sc">~</span> . <span class="sc">-</span> x2)</span></code></pre></div>
<pre><code>## y ~ x1</code></pre>
<p>Nous pourrions aussi transformer une variable.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">update</span>(f1, <span class="fu">sqrt</span>(.) <span class="sc">~</span> .)</span></code></pre></div>
<pre><code>## sqrt(y) ~ x1 + x2</code></pre>
<p>La fonction <code>update</code> est générique. Si le premier argument qu’elle reçoit est une formule, elle appelle la méthode <code>update.formula</code>. Dans un appel à <code>update.formula</code>, un point (symbole <code>.</code>) représente une partie de la formule originale. Le <code>.</code> à gauche du <code>~</code> représente le LHS de la formule fournie comme premier argument et le <code>.</code> à droite du <code>~</code> le RHS la formule fournie comme premier argument.</p>
</div>
</div>
<div id="manipulation-dinstructions" class="section level1" number="5">
<h1><span class="header-section-number">5</span> Manipulation d’instructions</h1>
<p>Il est possible d’écrire des instructions R complètes, sous forme d’expression R ou de chaîne de caractères, sans les évaluer.</p>
<p>Prenons par exemple l’instruction R suivante : <code>median(x = 1:10)</code>. Il s’agit d’un appel à la fonction <code>median</code>. Si nous soumettons cette instruction dans la console, elle est évaluée et sa valeur, ici l’objet retourné en sortie par la fonction <code>median</code>, est imprimée.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>## [1] 5.5</code></pre>
<p>Si nous ajoutons une assignation au début de l’instruction comme suit :</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">median</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code></pre></div>
<p>la sortie retournée par l’appel à la fonction <code>median</code> n’est pas imprimée. Elle est plutôt assignée au nom <code>out</code>, qui pointe donc maintenant vers un objet contenant la sortie produite.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>out</span></code></pre></div>
<pre><code>## [1] 5.5</code></pre>
<p>Mais comment stocker dans un objet l’instruction elle-même ?</p>
<div id="fonctions-quote-et-expression" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Fonctions <code>quote</code> et <code>expression</code></h2>
<p>La fonction <code>quote</code> retourne une instruction R non évaluée, que nous pouvons appeler « expression ».</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>out_quote <span class="ot">&lt;-</span> <span class="fu">quote</span>(<span class="fu">median</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>))</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(out_quote)</span></code></pre></div>
<pre><code>##  language median(x = 1:10)</code></pre>
<p>C’est un « élément de langage ».</p>
<p>La fonction <code>expression</code>, mentionnée dans les <a href="https://stt4230.rbind.io/communication_resultats/graphiques_r/#annotations-math%C3%A9matiques">notes sur les graphiques en R</a> pour l’ajout d’annotations mathématiques à un graphique, est similaire à la fonction <code>quote</code>, mais retourne un objet de langage un peu plus complexe.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>out_exp <span class="ot">&lt;-</span> <span class="fu">expression</span>(<span class="fu">median</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>))</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(out_exp)</span></code></pre></div>
<pre><code>##   expression(median(x = 1:10))</code></pre>
<p>Nous n’entrerons pas ici dans les détails techniques de la distinction entre ces deux types d’objets.</p>
</div>
<div id="fonction-eval" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Fonction <code>eval</code></h2>
<p>Lorsque nous désirons évaluer une expression R, nous pouvons la fournir en entrée à la fonction <code>eval</code>. Les objets retournés par les fonctions <code>quote</code> et <code>expression</code> s’évaluent de la même façon.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(out_quote)</span></code></pre></div>
<pre><code>## [1] 5.5</code></pre>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(out_exp)</span></code></pre></div>
<pre><code>## [1] 5.5</code></pre>
</div>
<div id="fonction-call" class="section level2" number="5.3">
<h2><span class="header-section-number">5.3</span> Fonction <code>call</code></h2>
<p>Si l’instruction que nous souhaitons manipuler est un appel à une fonction, nous pouvons aussi créer l’expression non évaluée de l’instruction avec la fonction <code>call</code>.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>out_call <span class="ot">&lt;-</span> <span class="fu">call</span>(<span class="st">&quot;median&quot;</span>, <span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(out_call)</span></code></pre></div>
<pre><code>##  language median(x = 1:10)</code></pre>
<p>Les objets <code>out_call</code> et <code>out_quote</code> sont équivalents.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(out_quote, out_call)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Évaluer <code>out_call</code> se réalise de la même façon qu’évaluer <code>out_quote</code> ou <code>out_exp</code>.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(out_call)</span></code></pre></div>
<pre><code>## [1] 5.5</code></pre>
</div>
<div id="fonction-parse" class="section level2" number="5.4">
<h2><span class="header-section-number">5.4</span> Fonction <code>parse</code></h2>
<p>Étant donné que les chaînes de caractères se manipulent facilement, il serait utile de pouvoir transformer une chaîne de caractères en expression. C’est ce que nous permet de faire la fonction <code>parse</code>.</p>
<p>Par exemple, si nous avons la chaîne de caractère suivante :</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>instruc_car <span class="ot">&lt;-</span> <span class="st">&quot;median(x = 1:10)&quot;</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(instruc_car)</span></code></pre></div>
<pre><code>##  chr &quot;median(x = 1:10)&quot;</code></pre>
<p>nous pouvons la transformer en expression non évaluée avec <code>parse</code> comme suit.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>out_parse <span class="ot">&lt;-</span> <span class="fu">parse</span>(<span class="at">text =</span> instruc_car)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(out_parse)</span></code></pre></div>
<pre><code>##   expression(median(x = 1:10))</code></pre>
<p>L’objet <code>out_parse</code> ressemble à l’objet <code>out_exp</code> et s’évalue de la même façon, avec la fonction <code>eval</code>.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(out_parse)</span></code></pre></div>
<pre><code>## [1] 5.5</code></pre>
<p>Nous avons donc parcouru le chemin de transformation suivant :</p>
<blockquote>
<p>instruction sous forme de chaîne de caractères,<br />
<span class="math inline">\(\rightarrow\)</span> expression non évaluée avec <code>parse</code>,<br />
<span class="math inline">\(\rightarrow\)</span> évaluation de l’expression avec <code>eval</code>.</p>
</blockquote>
<p>Grâce à ces outils, nous pourrions améliorer la fonction <code>reg_poly</code>. Vous aurez peut-être remarqué que dans l’impression de la sortie de cette fonction, le <code>Call</code> a toujours la même allure : <code>lm(formula = as.formula(formule))</code>. Ce n’est pas très informatif. Voici une deuxième version de cette fonction, utilisant <code>parse</code> et <code>eval</code> plutôt que <code>as.formula</code>, qui produit un affichage amélioré.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&#39; @inherit reg_poly title description params return</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>reg_poly_2 <span class="ot">&lt;-</span> <span class="cf">function</span>(y, x, dg){</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  instruc <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;lm(y ~ &quot;</span>, </span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="fu">paste0</span>(<span class="st">&quot;I(x^&quot;</span>, <span class="dv">1</span><span class="sc">:</span>dg, <span class="st">&quot;)&quot;</span>), <span class="at">collapse =</span> <span class="st">&quot; + &quot;</span>),</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;)&quot;</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text =</span> instruc)))</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reg_poly_2</span>(<span class="at">y =</span> cars<span class="sc">$</span>dist, <span class="at">x =</span> cars<span class="sc">$</span>speed, <span class="at">dg =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ I(x^1) + I(x^2) + I(x^3))
## 
## Coefficients:
## (Intercept)       I(x^1)       I(x^2)       I(x^3)  
##   -19.50505      6.80111     -0.34966      0.01025</code></pre>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reg_poly_2</span>(<span class="at">y =</span> cars<span class="sc">$</span>dist, <span class="at">x =</span> cars<span class="sc">$</span>speed, <span class="at">dg =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ I(x^1) + I(x^2) + I(x^3) + I(x^4) + I(x^5))
## 
## Coefficients:
## (Intercept)       I(x^1)       I(x^2)       I(x^3)       I(x^4)       I(x^5)  
##   -2.650053     5.484259    -1.426123     0.194049    -0.010040     0.000179</code></pre>
</div>
</div>
<div id="manipulation-de-lappel-dune-fonction" class="section level1" number="6">
<h1><span class="header-section-number">6</span> Manipulation de l’appel d’une fonction</h1>
<p>Dans le corps d’une fonction, il est parfois utile de pouvoir manipuler l’appel de la fonction.</p>
<p>Par exemple, la fonction <code>hist</code> utilise la façon dont la fonction a été appelée pour écrire le titre du graphique et le nom de l’axe des x.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">rnorm</span>(<span class="dv">100</span>))</span></code></pre></div>
<p><img src="/amelioration_code/metaprogrammation_r_2021_files/figure-html/unnamed-chunk-46-1.png" width="60%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">100</span>)</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(x)</span></code></pre></div>
<p><img src="/amelioration_code/metaprogrammation_r_2021_files/figure-html/unnamed-chunk-46-2.png" width="60%" style="display: block; margin: auto;" /></p>
<p>Comment arriver à faire pareil ?</p>
<div id="fonctions-substitute-et-deparse" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> Fonctions <code>substitute</code> et <code>deparse</code></h2>
<p>Essayons de trouver dans le corps de la fonction <code>hist</code> comment elle procède. En fait, la fonction <code>hist</code> étant générique, allons voir dans le corps de sa méthode par défaut.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(hist.default)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="co"># résultat non affiché ici, soumettre la commande dans la console pour le voir</span></span></code></pre></div>
<p>Les fonctions <code>substitute</code> et <code>deparse</code> sont utilisées pour créer l’objet <code>xname</code>, qui est ensuite utilisé dans les valeurs par défaut des arguments <code>main</code> et <code>xlab</code>.</p>
<div id="exemples-pour-mieux-comprendre-substitute-et-deparse" class="section level4 unnumbered">
<h4>Exemples pour mieux comprendre <code>substitute</code> et <code>deparse</code> :</h4>
<p></p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>fct1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">fct1</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(test)</span></code></pre></div>
<pre><code>##  int [1:10] 1 2 3 4 5 6 7 8 9 10</code></pre>
<p>La fonction <code>fct1</code> retourne ici un vecteur, soit le résultat de l’évaluation de l’expression fournie en entrée à l’argument <code>x</code>.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>fct2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">substitute</span>(x))</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">fct2</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(test)</span></code></pre></div>
<pre><code>##  language 1:10</code></pre>
<p>Lorsque <code>substitute</code> est utilisée dans le corps d’une fonction et qu’elle reçoit en entrée le nom d’un argument, elle retourne l’expression non évaluée fournie en entrée à cet argument dans l’appel de la fonction. La fonction <code>fct2</code> retourne donc une expression non évaluée (comme <code>quote</code> ou <code>call</code>).</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>fct3 <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">deparse</span>(<span class="fu">substitute</span>(x)))</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">fct3</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(test)</span></code></pre></div>
<pre><code>##  chr &quot;1:10&quot;</code></pre>
<p>Dans le corps de la fonction <code>fct3</code>, l’expression non évaluée retournée par <code>substitute</code> est transformée en chaîne de caractères par la fonction <code>deparse</code>. La fonction <code>deparse</code> permet de faire l’inverse de la fonction <code>parse</code> :</p>
<ul>
<li><code>deparse</code> : expression <span class="math inline">\(\rightarrow\)</span> chaîne de caractères,</li>
<li><code>parse</code>: chaîne de caractères <span class="math inline">\(\rightarrow\)</span> expression.</li>
</ul>
</div>
</div>
<div id="fonction-match.call" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Fonction <code>match.call</code></h2>
<p>Avec <code>substitute</code>, nous pouvons accéder à une expression assignée à un argument dans l’appel d’une fonction. La fonction <code>match.call</code>, que nous avons déjà mentionnée dans les <a href="https://stt4230.rbind.io/programmation/fonctions_r/#fonction-match.call">notes sur les fonctions</a>, permet quant à elle d’accéder à l’appel complet de la fonction.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>fct4 <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">match.call</span>())</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">fct4</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(test)</span></code></pre></div>
<pre><code>##  language fct4(x = 1:10)</code></pre>
<p>La fonction <code>match.call</code> retourne une expression non évaluée, comme <code>substitute</code>. Dans cette expression, il est possible d’accéder à des arguments en particulier grâce à l’opérateur <code>$</code>.</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>fct5 <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y){</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  appel <span class="ot">&lt;-</span> <span class="fu">match.call</span>()</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  appel_details <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">appel_complet =</span> appel, </span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">arg_x_exp =</span> appel<span class="sc">$</span>x,</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">arg_x_car =</span> <span class="fu">deparse</span>(appel<span class="sc">$</span>x),</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">arg_y_exp =</span> appel<span class="sc">$</span>y</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(appel_details)</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">fct5</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">y =</span> <span class="st">&quot;a&quot;</span>)</span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(test)</span></code></pre></div>
<pre><code>## List of 4
##  $ appel_complet: language fct5(x = 1:10, y = &quot;a&quot;)
##  $ arg_x_exp    : language 1:10
##  $ arg_x_car    : chr &quot;1:10&quot;
##  $ arg_y_exp    : chr &quot;a&quot;</code></pre>
<p>Dans cet exemple, la valeur fournie à l’argument <code>y</code> ne contient pas un appel à une fonction ou un opérateur. Il s’agit d’un seul élément, de type caractère. Son expression non évaluée est donc la valeur en caractères elle-même.</p>
<hr />
</div>
</div>
<div id="résumé" class="section level1" number="7">
<h1><span class="header-section-number">7</span> Résumé</h1>
<p>Métaprogrammation en R = manipulation d’éléments de langage (noms, formules, expressions, appels de fonctions, etc.) sans les évaluer</p>
<ul>
<li>assignation d’une valeur à un nom (sous forme de chaîne de caractères) : <code>assign</code></li>
<li>retour de la valeur assignée à un nom (sous forme de chaîne de caractères) : <code>get</code></li>
<li>appel à une fonction en fournissant les arguments dans une liste : <code>do.call</code></li>
<li>manipulation de formules :
<ul>
<li>créer une formule à partir d’une chaîne de caractères : <code>as.formula</code></li>
<li>mettre à jour une formule : <code>update.formula</code></li>
</ul></li>
<li>manipulation d’instructions sans les évaluer :
<ul>
<li>capturer une instruction sans l’évaluer :<code>quote</code>,<code>expression</code></li>
<li>écrire un appel de fonction sous forme d’expression (non évaluée) : <code>call</code></li>
<li>créer une expression (non évaluée) à partir d’une chaîne de caractères : <code>parse</code> (argument <code>text</code>)</li>
</ul></li>
<li>évaluation d’une expression : <code>eval</code></li>
<li>manipulation de l’appel d’une fonction :
<ul>
<li>capturer une partie de l’appel ou l’appel complet sous forme d’expression (non évaluée) : <code>substitute</code>, <code>match.call</code></li>
<li>transformer une expression (non évaluée) en chaîne de caractères : <code>deparse</code></li>
</ul></li>
</ul>
<hr />
</div>
<div id="références" class="section level1 unnumbered">
<h1>Références</h1>
<ul>
<li>R Core Team (2021). <em>R Language Definition</em>. R Foundation for Statistical Computing. Chapitre 6. URL <a href="http://cran.r-project.org/doc/manuals/r-patched/R-lang.html#Computing-on-the-language" class="uri">http://cran.r-project.org/doc/manuals/r-patched/R-lang.html#Computing-on-the-language</a></li>
<li>Wickham, H. (2014). <em>Advanced R</em>. CRC Press.
<ul>
<li>Chapitre 13 <em>Non-standard Evaluation</em>, URL <a href="http://adv-r.had.co.nz/Computing-on-the-language.html" class="uri">http://adv-r.had.co.nz/Computing-on-the-language.html</a></li>
<li>Chapitre 14. <em>Expressions</em>, URL <a href="http://adv-r.had.co.nz/Expressions.html" class="uri">http://adv-r.had.co.nz/Expressions.html</a></li>
</ul></li>
<li>Wickham, H. (2019). <em>Advanced R</em>. 2<sup>e</sup> édition. Chapman and Hall/CRC. Section 4. <em>Metaprogramming</em> URL <a href="https://adv-r.hadley.nz/metaprogramming.html" class="uri">https://adv-r.hadley.nz/metaprogramming.html</a></li>
</ul>
</div>
